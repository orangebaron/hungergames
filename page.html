<!DOCTYPE html>
<html>
  <head>
    <script>
      function player(name,gender) {
        this.name=name
        this.gender=gender
        this.items=[]
      }
      player.prototype = {
        alive: true,
        kills: 0
      }

      function event(template,probability) { //probility is relative; 4 is double the probability of 2 and half of 8
        this.template=template
        this.probability=probability
        this.plrCount=(template+' ').split('%').length - 1
      }
      event.prototype = {
        getStr: function(plrs) {
          var str=this.template
          plrs.forEach(function(plr,index) {
            str=str.replace('%'+index+';','<b>'+plr.name+'</b>')
          })
          return str
        },
        outcome: function(plrs){}
      }
      var nullEvent=new event('',0)

      function killEvent(template,probability,amtKillers) {
        event.call(this,template,probability)
        this.amtKillers=amtKillers
      }
      killEvent.prototype = Object.create(event.prototype)
      killEvent.prototype.outcome = function(plrs) {
        var amtKillers = this.amtKillers
        plrs.forEach(function(plr,index) {
          if (index>=amtKillers) {
            plr.alive=false
          }
        })
      }

      function pickUpEvent(template,probability,availableItems) {
        event.call(this,template,probability)
        this.plrCount=(template.replace('%i;','')).split('%').length - 1
        this.availableItems=fixEventTableProbabilities(availableItems)
      }
      pickUpEvent.prototype = Object.create(event.prototype)
      pickUpEvent.prototype.outcome = function(plrs) {
        var item = this.availableItems[Math.floor(Math.random()*this.availableItems.length)]
        this.item=item //temporarily, for reference in getStr
        plrs.forEach(function(plr) {
          plr.items.push(item)
        })
      }
      pickUpEvent.prototype.getStr = function(plrs) {
        var str=this.template.replace('%i;',this.item.article+' '+this.item.name)
        plrs.forEach(function(plr,index) {
          str=str.replace('%'+index+';','<b>'+plr.name+'</b>')
        })
        return str
      }

      function item(article,name,events,disables,probability) {
        this.article=article
        this.name=name
        this.events=events//which events having this item can cause
        this.disables=disables//which events this item makes not happen
        this.probability=probability
      }
      item.prototype = {
        removeTableItems:function(table) {
          this.disables.forEach(function(disable) {
            table[disable]=nullEvent
          })
          return table
        }
      }
      var axe=new item('an','axe',[new killEvent('%0; killed %1; with an axe.',7,1)],[0],5)
      var disc=new item('an','Emoji Movie disc',[new event('%0; watched the Emoji Movie.',4)],[4],2)

      var items=[axe,disc]
      var events=[new killEvent('%0; killed %1;.',6,1),
        new killEvent('%0; and %1; practiced unsafe dating and died.',1,0),
        new event('%0; and %1; practiced safe dating.',1),
        new killEvent('%0; committed sudoku.',1,0),
        new pickUpEvent('%0; recieved %i; from a sponsor.',1,items),
        new event('%0; tried the blue whale challenge.',3)]
      cornucopiaEvents=[new pickUpEvent('%0; picked up %i; from the cornucopia.',20,items),
        new event('%0; ran from the cornucopia.',9)]
      var players=[new player('thumbtack',true),new player('uwe',true),new player('steven',true),new player('erikkk',true),
        new player('michael',true),new player('lucio',false),new player('jarry',true)]
      var today=1

      function putText(text) {
        document.getElementById('text').innerHTML+='<p>'+text+'</p>'
      }
      function fixEventTableProbabilities(tab) {
        var tab2=[]
        tab.forEach(function(item){
          for (var i=0;i<item.probability;i++){
            tab2.push(item)
          }
        })
        return tab2
      }
      function amtAlive() {
        var alive=0
        players.forEach(function(plr){
          if (plr.alive) {
            alive++
          }
        })
        return alive
      }

      function doEvents() {
        var playersLeft=[]
        players.forEach(function(plr){
          if (plr.alive) {
            playersLeft.push(plr)
          }
        })

        var currentEvent
        var currentPlrs = []
        while (playersLeft.length>0 && amtAlive()>1) {
          var index=Math.floor(Math.random()*playersLeft.length)
          currentPlrs.push(playersLeft[index])
          playersLeft.splice(index,1)

          if (currentEvent == null) {
            var tempEvents = events.slice(0)
            if (today==1) {
              tempEvents=tempEvents.concat(cornucopiaEvents)
            }
            currentPlrs[0].items.forEach(function(i) {
              tempEvents=i.removeTableItems(tempEvents)
              i.events.forEach(function(e) {
                tempEvents = tempEvents.concat(e)
              })
            })
            tempEvents=fixEventTableProbabilities(tempEvents)
            do { currentEvent = tempEvents[Math.floor(Math.random()*tempEvents.length)] }
            while (currentEvent.plrCount > playersLeft.length + 1)
          }

          console.assert(currentEvent.plrCount >= currentPlrs.length)
          if (currentEvent.plrCount == currentPlrs.length) {
            currentEvent.outcome(currentPlrs)
            putText(currentEvent.getStr(currentPlrs))
            currentPlrs=[]
            currentEvent=null
          }
        }
      }

      function displayDead() {
        var alive=amtAlive()
        players.forEach(function(plr) {
          if (plr.alive) {
            if (alive>1) {
              putText(plr.name+' is alive.')
            }
            else {
              putText(plr.name+' is the victor!')
            }
          }
          else if (plr.deathDate != null) {
            putText(plr.name+' died on day '+plr.deathDate+'.')
          }
          else {
            putText(plr.name+' died.')
            plr.deathDate=today
          }
        })
      }
    </script>
  </head>
  <body>
    <div id='text'></div>
    <script>
      for (;amtAlive()>1;today++) {
        putText('DAY '+today+':')
        doEvents()
        putText('RESULTS:')
        displayDead()
      }
    </script>
  </body>
</html>
