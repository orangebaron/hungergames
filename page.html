<!DOCTYPE html>
<html>
  <head>
    <script>
      function player(name,gender) {
        this.name=name
        this.gender=gender
      }
      player.prototype = {
        items: [],
        alive: true,
        uninjured: true,
        kills: 0
      }

      function event(template,probability) { //probility is relative; 4 is double the probability of 2 and half of 8
        this.template=template
        this.probability=probability
        this.plrCount=(template+" ").split('%').length - 1
      }
      event.prototype = {
        getStr: function(plrs) {
          var str=this.template
          plrs.forEach(function(plr,index) {
            str=str.replace('%'+index+';','<b>'+plr.name+'</b>')
          })
          return str
        }
      }
      var nullEvent=new event('',0)

      function killEvent(template,probability,amtKillers) {
        event.call(this,template,probability)
        this.amtKillers=amtKillers
      }
      killEvent.prototype = Object.create(event.prototype)
      killEvent.prototype.outcome = function(plrs) {
        var amtKillers = this.amtKillers
        plrs.forEach(function(plr,index) {
          if (index>=amtKillers) {
            plr.alive=false
          }
        })
      }

      function item(name,events,disables) {
        this.name=name
        this.events=events//which events having this item can cause
        this.disables=disables//which events this item makes not happen
      }
      item.prototype = {
        removeTableItems:function(table) {
          this.disables.forEach(function(disable) {
            table[disable]=nullEvent
          })
          return table
        }
      }
      var axe=new item('axe',[new killEvent('%0; killed %1; with an axe.',7,1)],[0])

      var events=[new killEvent('%0; killed %1;.',5,1),
        new killEvent('%0; and %1; practiced unsafe dating and died.',1,0),
        new killEvent('%0; committed sudoku.',2,0)]
      var players=[new player('thumbtack',true),new player('uwe',true),new player('steven',true),new player('erikkk',true),
        new player('michael',true),new player('lucio',false),new player('jarry',true)]
      players[1].items=[axe]
      var itemRegions=[{name:'cornucopia',items:[]}]
      var today=1

      function putText(text) {
        document.getElementById('text').innerHTML+='<p>'+text+'</p>'
      }
      function fixEventTableProbabilities(tab) {
        var tab2=[]
        tab.forEach(function(item){
          for (var i=0;i<item.probability;i++){
            tab2.push(item)
          }
        })
        return tab2
      }

      function doEvents() {
        var playersLeft=[]
        players.forEach(function(plr){
          if (plr.alive) {
            playersLeft.push(plr)
          }
        })

        var currentEvent
        var currentPlrs = []
        while (playersLeft.length>0) {
          var index=Math.floor(Math.random()*playersLeft.length)
          currentPlrs.push(playersLeft[index])
          playersLeft.splice(index,1)

          if (currentEvent == null) {
            var tempEvents = events.slice(0)
            currentPlrs[0].items.forEach(function(i) {
              tempEvents=i.removeTableItems(tempEvents)
              i.events.forEach(function(e) {
                tempEvents = tempEvents.concat(e)
              })
            })
            tempEvents=fixEventTableProbabilities(tempEvents)
            if (currentPlrs[0].name=='uwe'){
              console.log(tempEvents)
            }
            do { currentEvent = tempEvents[Math.floor(Math.random()*tempEvents.length)] }
            while (currentEvent.plrCount > playersLeft.length + 1)
          }

          console.assert(currentEvent.plrCount >= currentPlrs.length)
          if (currentEvent.plrCount == currentPlrs.length) {
            putText(currentEvent.getStr(currentPlrs))
            currentEvent.outcome(currentPlrs)
            currentPlrs=[]
            currentEvent=null
          }
        }
      }

      function displayDead() {
        players.forEach(function(plr) {
          if (plr.alive) {
            putText(plr.name+' is alive.')
          }
          else if (plr.deathDate != null) {
            putText(plr.name+' died on day '+plr.deathDate+'.')
          }
          else {
            putText(plr.name+' died.')
            plr.deathDate=today
          }
        })
      }
    </script>
  </head>
  <body>
    <div id='text'></div>
    <script>
      doEvents()
      putText('RESULTS:')
      displayDead()
    </script>
  </body>
</html>
